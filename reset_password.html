<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Reset password</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <style>
    :root { --bg:#0b1220; --card:#121a2b; --text:#e6ecf2; --muted:#93a0b4; --accent:#6ea8fe; --danger:#ff6b6b; --ok:#35c759; }
    @media (prefers-color-scheme: light) { :root { --bg:#f5f7fb; --card:#ffffff; --text:#0b1220; --muted:#5b6678; --accent:#2b6eff; --danger:#c0392b; --ok:#1a7f37; } }
    *{box-sizing:border-box} 
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;background:var(--bg);color:var(--text);display:grid;min-height:100svh;place-items:center;padding:24px}
    .card{width:min(440px,100%);background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:24px 22px}
    h1{margin:0 0 10px;font-size:1.4rem} 
    p{margin:0 0 18px;color:var(--muted)}
    label{display:block;margin:14px 0 6px} 
    input{width:100%;padding:12px 14px;border-radius:10px;border:1px solid rgba(255,255,255,.18);background:transparent;color:var(--text)}
    button{width:100%;margin-top:16px;padding:12px 14px;border:0;border-radius:12px;background:var(--accent);color:white;font-weight:600;cursor:pointer}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .msg{margin-top:12px;font-size:.92rem;display:none}
    .ok{color:var(--ok)} .err{color:var(--danger)}
    .hidden{display:none !important}
  </style>
  <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="card">
    <h1>Reset your password</h1>
    <p id="status">Validating your linkâ€¦</p>

    <form id="form" class="hidden" autocomplete="off">
      <label for="password">New password</label>
      <input id="password" name="password" type="password" minlength="8" required placeholder="At least 8 characters" />
      <label for="confirm">Confirm password</label>
      <input id="confirm" name="confirm" type="password" required placeholder="Re-enter your password" />
      <button id="submitBtn" type="submit">Update password</button>
    </form>

    <div id="ok" class="msg ok">Password updated.</div>
    <div id="err" class="msg err"></div>
    
    <!-- New Button -->
    <button id="redirectBtn" class="hidden">Go To Privanta</button>
  </div>

<script>
  const SUPABASE_URL = "https://jprxjqaqptribtpownjs.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpwcnhqcWFxcHRyaWJ0cG93bmpzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM4NTcxMTIsImV4cCI6MjA2OTQzMzExMn0.lsFWp52gDcmckDdPu8TGmyLlA7cAnfEJuRKlOJV5bzw";
  const REDIRECT_URL = "https://privanta.jetadmin.io/";

  let supabaseClient;
  document.addEventListener('DOMContentLoaded', async () => {
    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { flowType: 'implicit' } });
    const ok = await establishSessionFromUrl(supabaseClient);
    const status = document.getElementById('status');
    if (!ok) {
      status.textContent = "This reset link is invalid or has expired.";
      return;
    }
    status.textContent = "Choose a new password.";
    document.getElementById('form').classList.remove('hidden');
    setupForm();
  });

  async function establishSessionFromUrl(sb) {
    const url = new URL(window.location.href);
    const code = url.searchParams.get('code');
    if (code) {
      const { data, error } = await sb.auth.exchangeCodeForSession(code);
      if (error) { console.warn(error); return false; }
      return !!data?.session;
    }
    const hash = parseHashParams(window.location.hash);
    if (hash.access_token && hash.refresh_token && (hash.type === 'recovery' || hash.type === 'invite')) {
      const { data, error } = await sb.auth.setSession({ access_token: hash.access_token, refresh_token: hash.refresh_token });
      if (error) { console.warn(error); return false; }
      history.replaceState({}, document.title, window.location.pathname);
      return !!data?.session;
    }
    return false;
  }

  function parseHashParams(hash) {
    const out = {};
    (hash || '').replace(/^#/, '').split('&').forEach(kv => {
      const [k, v] = kv.split('=');
      if (k) out[decodeURIComponent(k)] = decodeURIComponent(v || '');
    });
    return out;
  }

  function setupForm() {
    const form = document.getElementById('form');
    const pwd = document.getElementById('password');
    const confirm = document.getElementById('confirm');
    const btn = document.getElementById('submitBtn');
    const ok = document.getElementById('ok');
    const err = document.getElementById('err');
    const redirectBtn = document.getElementById('redirectBtn');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      ok.style.display = 'none'; err.style.display = 'none';

      const p1 = pwd.value.trim(), p2 = confirm.value.trim();
      if (p1.length < 8) { err.textContent = "Password must be at least 8 characters."; err.style.display = 'block'; return; }
      if (p1 !== p2) { err.textContent = "Passwords do not match."; err.style.display = 'block'; return; }

      btn.disabled = true;
      const { error } = await supabaseClient.auth.updateUser({ password: p1 });
      btn.disabled = false;

      if (error) {
        err.textContent = error.message || "Could not update password. The link may have expired.";
        err.style.display = 'block';
        return;
      }
      ok.style.display = 'block';
      redirectBtn.classList.remove('hidden');
      form.reset();
    });

    redirectBtn.addEventListener('click', () => {
      window.location.href = REDIRECT_URL;
    });
  }
</script>
</body>
</html>
