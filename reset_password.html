<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
  // If jsDelivr is blocked, swap to:
  // import { createClient } from "https://unpkg.com/@supabase/supabase-js@2/+esm";

  // CONFIG
  const SUPABASE_URL = "https://jprxjqaqptribtpownjs.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpwcnhqcWFxcHRyaWJ0cG93bmpzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM4NTcxMTIsImV4cCI6MjA2OTQzMzExMn0.lsFWp52gDcmckDdPu8TGmyLlA7cAnfEJuRKlOJV5bzw";
  const APP_SIGNIN_URL = "https://privanta.jetadmin.io/";

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // Boot
  (async function init() {
    const status = document.getElementById('status');
    const ok = await establishSessionFromUrl(supabase);
    if (!ok) {
      status.textContent = "This reset link is invalid or has expired.";
      return;
    }
    status.textContent = "Choose a new password.";
    document.getElementById('form').classList.remove('hidden');
    setupForm();
  })();

  // Handle both newer ?code= and legacy #access_token flows
  async function establishSessionFromUrl(sb) {
    try {
      const url = new URL(window.location.href);
      const code = url.searchParams.get('code');
      if (code) {
        const { data, error } = await sb.auth.exchangeCodeForSession(code);
        if (error) { console.warn(error); return false; }
        return !!data?.session;
      }
      const hash = parseHashParams(window.location.hash);
      if (hash.access_token && hash.refresh_token && (hash.type === 'recovery' || hash.type === 'invite')) {
        const { data, error } = await sb.auth.setSession({ access_token: hash.access_token, refresh_token: hash.refresh_token });
        if (error) { console.warn(error); return false; }
        history.replaceState({}, document.title, window.location.pathname);
        return !!data?.session;
      }
      return false;
    } catch (e) {
      console.warn(e);
      return false;
    }
  }

  function parseHashParams(hash) {
    const out = {};
    (hash || '').replace(/^#/, '').split('&').forEach(kv => {
      const [k, v] = kv.split('=');
      if (k) out[decodeURIComponent(k)] = decodeURIComponent(v || '');
    });
    return out;
  }

  function setupForm() {
    const form = document.getElementById('form');
    const pwd = document.getElementById('password');
    const confirm = document.getElementById('confirm');
    const btn = document.getElementById('submitBtn');
    const err = document.getElementById('err');
    const successBox = document.getElementById('successBox') || createSuccessBox();

    // If the HTML didn’t include successBox, create it:
    function createSuccessBox() {
      const box = document.createElement('div');
      box.id = 'successBox';
      box.className = 'msg ok';
      box.style.textAlign = 'center';
      box.style.display = 'none';
      box.innerHTML = `
        <div style="font-weight:600; margin-bottom:10px;">Password Updated</div>
        <a id="signInBtn" href="${APP_SIGNIN_URL}" style="
          display:inline-block; padding:12px 16px; border-radius:12px;
          background:var(--accent); color:#fff; text-decoration:none; font-weight:600;">
          Sign in
        </a>
      `;
      document.querySelector('.card').appendChild(box);
      return box;
    }

    // make sure clicking the button goes to your app
    document.addEventListener('click', (e) => {
      if (e.target && e.target.id === 'signInBtn') {
        e.preventDefault();
        window.location.assign(APP_SIGNIN_URL);
      }
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault(); // stop any navigation
      err.style.display = 'none';
      err.textContent = '';

      const p1 = pwd.value.trim(), p2 = confirm.value.trim();
      if (p1.length < 8) { err.textContent = "Password must be at least 8 characters."; err.style.display = 'block'; return; }
      if (p1 !== p2) { err.textContent = "Passwords do not match."; err.style.display = 'block'; return; }

      btn.disabled = true;
      try {
        const { error } = await supabase.auth.updateUser({ password: p1 });
        if (error) {
          err.textContent = error.message || "Could not update password. The link may have expired.";
          err.style.display = 'block';
          return;
        }

        // Success → hide form, show success UI
        form.classList.add('hidden');
        document.getElementById('status').textContent = '';
        successBox.style.display = 'block';

        // Optional: sign out after reset
        // await supabase.auth.signOut();

        // Optional: auto redirect after 1.5s
        setTimeout(() => { window.location.assign(APP_SIGNIN_URL); }, 1500);

      } catch (ex) {
        err.textContent = ex.message || String(ex);
        err.style.display = 'block';
      } finally {
        btn.disabled = false;
      }
    });
  }
</script>
