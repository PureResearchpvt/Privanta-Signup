<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sign up</title>
  <style>
    :root { --bg:#FFFFFF; --card:#121821; --muted:#6b7683; --text:#e8edf2; --accent:#6ea8fe; }
    body { margin:0; font-family:Inter, system-ui, Arial, sans-serif; background:var(--bg); color:var(--text); display:grid; min-height:100vh; place-items:center; }
    .card { width:min(420px,92vw); background:var(--card); border:1px solid #1d2530; border-radius:16px; padding:28px; box-shadow:0 8px 30px rgba(0,0,0,.25); }
    h1 { margin:0 0 6px; font-size:22px; font-weight:650; }
    p { margin:0 0 18px; color:var(--muted); font-size:13px; }
    form { display:grid; gap:12px; margin-top:10px; }
    label { font-size:12px; color:#aab3bd; }
    input { width:100%; padding:12px 12px; border-radius:10px; border:1px solid #222b36; background:#0e141b; color:var(--text); outline:none; }
    input:focus { border-color:#2a74ff; box-shadow:0 0 0 3px rgba(46,120,255,.2); }
    button { padding:12px 14px; border:0; border-radius:10px; background:linear-gradient(180deg,#79a9ff,#5b8cff); color:#0b1220; font-weight:700; cursor:pointer; }
    .muted-btn { background:#1b2430; color:#cdd6df; font-weight:600; }
    .row { display:grid; gap:10px; grid-template-columns:1fr 1fr; }
    .hidden { display:none; }
    .msg { margin-top:10px; font-size:13px; }
    .error { color:#ffb3b3; }
    .success { color:#92ffb3; }
    .fineprint { margin-top:8px; color:#97a3af; font-size:12px; }
    .link { background:none; border:0; padding:0; color:var(--accent); text-decoration:underline; cursor:pointer; font:inherit; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="card">
    <h1 id="title">Create your trial Privanta account</h1>
    <p id="subtitle">Use your work email to sign up.</p>

    <!-- Self-signup form -->
    <form id="signup-form">
      <div>
        <label for="name">Full name</label>
        <input id="name" type="text" autocomplete="name" placeholder="Your name" required />
      </div>
      <div>
        <label for="email">Email</label>
        <input id="email" type="email" autocomplete="email" placeholder="you@company.com" required />
      </div>
      <div class="row">
        <div>
          <label for="password">Password</label>
          <input id="password" type="password" autocomplete="new-password" placeholder="••••••••" required />
        </div>
        <div>
          <label for="confirm">Confirm</label>
          <input id="confirm" type="password" autocomplete="new-password" placeholder="••••••••" required />
        </div>
      </div>
      <button id="signup-btn" type="submit">Create account</button>
      <div class="msg" id="signup-msg"></div>
    </form>

    <!-- Forgot password trigger + reset form -->
    <p class="fineprint">
      <button type="button" id="forgot" class="link">Forgot password?</button>
    </p>
    <form id="reset-form" class="hidden">
      <label for="reset-email">Enter your email</label>
      <input id="reset-email" type="email" placeholder="you@company.com" required />
      <button id="reset-btn" type="submit">Send reset link</button>
      <div class="msg" id="reset-msg"></div>
    </form>

    <!-- Accept-invite / set-password (also used for password recovery completion) -->
    <form id="invite-form" class="hidden">
      <p>Welcome! Set a password to continue.</p>
      <div class="row">
        <div>
          <label for="inv-pass">New password</label>
          <input id="inv-pass" type="password" autocomplete="new-password" placeholder="••••••••" required />
        </div>
        <div>
          <label for="inv-confirm">Confirm</label>
          <input id="inv-confirm" type="password" autocomplete="new-password" placeholder="••••••••" required />
        </div>
      </div>
      <button id="invite-btn" type="submit">Set password & continue</button>
      <div class="msg" id="invite-msg"></div>
      <p class="fineprint">If this page didn’t open from your email link, open the link in the same browser.</p>
    </form>

    <button id="go-to-app" class="muted-btn hidden">Open the app</button>
  </div>

  <script>
    // --- CONFIG ---
    const SUPABASE_URL = "https://jprxjqaqptribtpownjs.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpwcnhqcWFxcHRyaWJ0cG93bmpzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM4NTcxMTIsImV4cCI6MjA2OTQzMzExMn0.lsFWp52gDcmckDdPu8TGmyLlA7cAnfEJuRKlOJV5bzw";
    const JET_ADMIN_APP_URL = "https://privanta.jetadmin.io/";
    const AUTH_URL = "https://pureresearchpvt.github.io/Privanta-Signup/Privanta_Signup.html";

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const $ = (id) => document.getElementById(id);
    const show = (el) => el.classList.remove("hidden");
    const hide = (el) => el.classList.add("hidden");

    // If opened in an iframe via email link, pop out so Supabase session can set correctly
    if (window.self !== window.top && (location.search.includes("type=") || location.hash.includes("type="))) {
      window.top.location = window.location.href;
    }

    // --- Init: detect invite/recovery/signup and show the right form ---
    (async function init() {
      const url = new URL(window.location.href);
      const type = url.searchParams.get("type") || url.hash.match(/type=(\w+)/)?.[1];

      if (type === "recovery") {
        // From password reset email
        hide($("signup-form"));
        $("title").textContent = "Reset your password";
        $("subtitle").textContent = "Enter a new password to continue.";
        show($("invite-form"));
      } else if (type === "invite" || type === "signup") {
        // Invite or post-signup confirm – session usually present, but UI is the same
        hide($("signup-form"));
        $("title").textContent = "Set your password";
        $("subtitle").textContent = "Finish setting up your account.";
        show($("invite-form"));
      } else {
        // Default: self-signup
        show($("signup-form"));
      }

      // Also react to auth events in case the session sets a moment later
      supabase.auth.onAuthStateChange((event) => {
        if (event === "PASSWORD_RECOVERY") {
          hide($("signup-form"));
          $("title").textContent = "Reset your password";
          $("subtitle").textContent = "Enter a new password to continue.";
          show($("invite-form"));
        }
      });
    })();

    // --- Self-signup flow ---
    $("signup-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      $("signup-msg").textContent = "";
      const name = $("name").value.trim();
      const email = $("email").value.trim().toLowerCase();
      const password = $("password").value;
      const confirm = $("confirm").value;

      if (password !== confirm) {
        $("signup-msg").textContent = "Passwords do not match.";
        $("signup-msg").className = "msg error";
        return;
      }

      $("signup-btn").disabled = true;
      const { data, error } = await supabase.auth.signUp({
        email,
        password,
        options: {
          data: { full_name: name }, // add more metadata if you like, e.g., app_plan: 'free'
          emailRedirectTo: AUTH_URL + "?type=signup"
        }
      });

      if (error) {
        $("signup-msg").textContent = error.message;
        $("signup-msg").className = "msg error";
        $("signup-btn").disabled = false;
        return;
      }

      // If email confirmations are disabled, a session may already exist – go straight to the app
      if (data?.session) {
        window.location.href = JET_ADMIN_APP_URL;
        return;
      }

      $("signup-msg").textContent = "Check your email to confirm your account. After confirming, you’ll be redirected.";
      $("signup-msg").className = "msg success";
      show($("go-to-app"));
      $("go-to-app").onclick = () => window.location.href = JET_ADMIN_APP_URL;
    });

    // --- Invite / Set new password (also used after reset) ---
    $("invite-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      $("invite-msg").textContent = "";
      const pass = $("inv-pass").value;
      const conf = $("inv-confirm").value;
      if (pass !== conf) {
        $("invite-msg").textContent = "Passwords do not match.";
        $("invite-msg").className = "msg error";
        return;
      }
      $("invite-btn").disabled = true;
      const { error } = await supabase.auth.updateUser({ password: pass });
      if (error) {
        $("invite-msg").textContent = error.message;
        $("invite-msg").className = "msg error";
        $("invite-btn").disabled = false;
        return;
      }
      $("invite-msg").textContent = "Password set. Redirecting…";
      $("invite-msg").className = "msg success";
      setTimeout(() => (window.location.href = JET_ADMIN_APP_URL), 800);
    });

    // --- Forgot password: send reset email ---
    $("forgot").onclick = () => show($("reset-form"));

    $("reset-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      $("reset-msg").textContent = "";
      const email = $("reset-email").value.trim().toLowerCase();
      $("reset-btn").disabled = true;

      const { error } = await supabase.auth.resetPasswordForEmail(email, {
        redirectTo: AUTH_URL + "?type=recovery"
      });

      if (error) {
        $("reset-msg").textContent = error.message;
        $("reset-msg").className = "msg error";
        $("reset-btn").disabled = false;
        return;
      }
      $("reset-msg").textContent = "Check your email for a reset link.";
      $("reset-msg").className = "msg success";
    });
  </script>
</body>
</html>
